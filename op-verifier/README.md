# @ensdomains/op-verifier

A complete Solidity library that facilitates sending CCIP-Read requests for Optimism state, and verifying the responses.

For a detailed readme and usage instructions, see the [monorepo readme](https://github.com/ensdomains/evmgateway/tree/main).

## Testing

Start up a devnet by following Optimism's instructions [here](https://community.optimism.io/docs/developers/build/dev-node/#do-i-need-this).

Then, deploy the L2 contract:

```
bun run hardhat deploy --network opDevnetL2
```

Followed by the L1 contract:

```
bun run hardhat deploy --network opDevnetL1
```

The L1 contracts contain a reference to the L2 contract, and so will require redeploying if the L2 contract changes.

Finally, run the tests:

```
hardhat test --network opDevnetL1
```

The tests will require small modifications to work on public testnets; specifically, contract addresses are currently fetched from `http://localhost:8080/addresses.json`; this will need to be made conditional on the network being used.

## Deployed addresses

### Optimism

#### L1

- OPVerifier = [0x0e8DA38565915B7e74e2d78F80ba1BF815F34116](https://sepolia.etherscan.io/address/0x0e8DA38565915B7e74e2d78F80ba1BF815F34116#code)
- TestL1 = [0x00198c6c94522A81698190ADF411641995Eb180c](https://sepolia.etherscan.io/address/0x00198c6c94522A81698190ADF411641995Eb180c#code
)
#### L2

- TestL2 = [0x94fbCE7ca1a0152cfC99F90f4421d31cf356c896](https://sepolia-optimism.etherscan.io/address/0x94fbCE7ca1a0152cfC99F90f4421d31cf356c896)

#### Gateway url

- https://op-sepolia-gateway-worker.ens-cf.workers.dev/{sender}/{data}.json

### Base

#### L1

- OPVerifier = [0xAdef74372444e716C0473dEe1F9Cb3108EFa3818](https://sepolia.etherscan.io/address/0xAdef74372444e716C0473dEe1F9Cb3108EFa3818#code
)
- TestL1 = [0x540C93800699C044dB8cf1f0F059ca0FA5CaED92](https://sepolia.etherscan.io/address/0x540C93800699C044dB8cf1f0F059ca0FA5CaED92#code)

#### L2

- TestL2 = [0x94fbCE7ca1a0152cfC99F90f4421d31cf356c896](https://sepolia.basescan.org/address/0x94fbCE7ca1a0152cfC99F90f4421d31cf356c896#code)

#### Gateway url

- https://base-sepolia-gateway-worker.ens-cf.workers.dev/{sender}/{data}.json

## OPOutputLookup

* Address: 0x475dc200b71dbd9776518C299e281766FaDf4A30
* Deterministic Deployment Proxy: 0x4e59b44847b379578588920cA78FbF26c0B4956C
* Salt: 0x0000000000000000000000000000000000000000000000000000000000000000
* Contract: lib/OPOutputLookup.sol:OPOutputLookup
* Solidity: 0.8.26
* Optimizer Runs: 200

Deployment Calldata

```
0x00000000000000000000000000000000000000000000000000000000000000006080604052348015600f57600080fd5b50611ea38061001f6000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c8063c81263f91161005b578063c81263f914610146578063d1d3ee3614610166578063e2dd1533146101b8578063e4ee14061461021457600080fd5b806311f2454f1461008d5780637a496563146100b6578063bab2c5ef146100d7578063babba784146100f7575b600080fd5b6100a061009b3660046117e9565b610227565b6040516100ad9190611824565b60405180910390f35b6100c96100c436600461185b565b610259565b6040516100ad929190611890565b6100ea6100e536600461185b565b61028c565b6040516100ad9190611905565b61010a6101053660046117e9565b61039c565b6040805194855263ffffffff90931660208501526001600160401b03909116918301919091526001600160a01b031660608201526080016100ad565b61015961015436600461193c565b6103c0565b6040516100ad9190611959565b610179610174366004611979565b6104cc565b6040805195865260208601949094526001600160401b039092169284019290925260608301919091526001600160a01b0316608082015260a0016100ad565b6101cb6101c636600461185b565b6104f5565b6040805196875260208701959095526001600160401b039093169385019390935260608401526001600160a01b03909116608083015263ffffffff1660a082015260c0016100ad565b61010a6102223660046117e9565b61051f565b604080516060810182526000808252602082018190529181019190915261025085858585610531565b95945050505050565b604080516060810182526000808252602082018190529181018290526102808585856106a9565b91509150935093915050565b6040805160808101825260008082526020820181905291810182905260608101919091526102b9846103c0565b819060018111156102cc576102cc6118cd565b908160018111156102df576102df6118cd565b9052506001815160018111156102f7576102f76118cd565b0361032a57600080600061030c8787876104f5565b50506020880193909352506060860152604085015250610395915050565b60008151600181111561033f5761033f6118cd565b0361037c57600080610352868686610259565b6020850191909152805160608501526040908101516001600160801b031690840152506103959050565b604051636dfa9d6760e11b815260040160405180910390fd5b9392505050565b6000806000806103ae88888888610a4c565b929b919a509850909650945050505050565b6000816001600160a01b031663f2b4e6176040518163ffffffff1660e01b8152600401602060405180830381865afa92505050801561041c575060408051601f3d908101601f19168201909252610419918101906119bf565b60015b1561043b576001600160a01b038116156104395750600192915050565b505b816001600160a01b0316639b5f694a6040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015610495575060408051601f3d908101601f19168201909252610492918101906119bf565b60015b1561037c576001600160a01b038116156104b25750600092915050565b50604051636dfa9d6760e11b815260040160405180910390fd5b60008060008060006104e089898989610c36565b94509450945094509450945094509450945094565b60008060008060008061050989898961102a565b949e939d50919b50995097509095509350505050565b6000806000806103ae888888886110b9565b604080516060810182526000808252602082018190529181018290529061055786611187565b60405163a25ae55760e01b8152600481018790529091506000906001600160a01b0383169063a25ae55790602401606060405180830381865afa1580156105a2573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105c69190611a5f565b90508481602001516001600160801b0316426105e29190611adf565b1015610630578581602001516001600160801b0316426106029190611adf565b6040516328711f9f60e01b815260048101929092526024820152604481018690526064015b60405180910390fd5b60008411801561065757508381602001516001600160801b0316426106559190611adf565b115b1561069f578581602001516001600160801b0316426106769190611adf565b60405163107b0e1960e01b81526004810192909252602482015260448101859052606401610627565b9695505050505050565b6040805160608101825260008082526020820181905291810182905260006106d086611187565b9050600080826001600160a01b03166369f16eec6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610713573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107379190611af2565b905060006107458842611adf565b90505b81831161096b5760405163a25ae55760e01b8152600481018490526000906001600160a01b0386169063a25ae55790602401606060405180830381865afa158015610797573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107bb9190611a5f565b602001516001600160801b031690506000856001600160a01b031663a25ae557856040518263ffffffff1660e01b81526004016107fa91815260200190565b606060405180830381865afa158015610817573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061083b9190611a5f565b602001516001600160801b03169050828211156108665761085d600186611adf565b9350505061096b565b6000828211156108b15761087a8383611adf565b6108848787611adf565b61088e8587611adf565b6108989190611b0b565b6108a29190611b22565b6108ac9087611b44565b6108b3565b855b9050848111156108c05750835b60405163a25ae55760e01b8152600481018290526000906001600160a01b0389169063a25ae55790602401606060405180830381865afa158015610908573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061092c9190611a5f565b602001516001600160801b031690508481116109545761094d826001611b44565b9650610962565b61095f600183611adf565b95505b50505050610748565b60405163a25ae55760e01b8152600481018390526000906001600160a01b0386169063a25ae55790602401606060405180830381865afa1580156109b3573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109d79190611a5f565b9050428882602001516001600160801b03166109f39190611b44565b1015610a3c578281602001516001600160801b031642610a139190611adf565b60405163107b0e1960e01b81526004810192909252602482015260448101899052606401610627565b9199919850909650505050505050565b6000806000806000610a5d89611232565b604051632ee2a87f60e21b8152600481018a90529091506000906001600160a01b0383169063bb8aa1fc90602401606060405180830381865afa158015610aa8573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610acc9190611b6e565b809550819350829750505050610b40836001600160a01b031663bcef3b556040518163ffffffff1660e01b8152600401602060405180830381865afa158015610b19573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b3d9190611af2565b90565b95506001600160401b038116935087610b598542611adf565b1015610b9c5788610b736001600160401b03861642611adf565b6040516366460f9d60e01b81526004810192909252602482015260448101899052606401610627565b600087118015610bbd575086610bbb6001600160401b03861642611adf565b115b15610bff5788610bd66001600160401b03861642611adf565b604051631fc476cf60e21b81526004810192909252602482015260448101889052606401610627565b610c08836112d2565b15610c29576040516336834a3160e21b8152600481018a9052602401610627565b5050945094509450949050565b60008080808080610c478842611adf565b90506000610c548b611232565b90506000610c628284611359565b60405163254bd68360e01b815263ffffffff8d16600482015260248101829052600160448201529091506000906001600160a01b0384169063254bd68390606401600060405180830381865afa158015610cc0573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052610ce89190810190611bb7565b90508051600003610d0f5760405163d13b267760e01b8152600481018c9052602401610627565b6000610d5482600081518110610d2757610d27611d68565b60200260200101516020015160e081901c9160a082901c6001600160401b0316916001600160a01b031690565b92505050610d61816112d2565b15610e605781600081518110610d7957610d79611d68565b602002602001015160000151600003610da85760405163d13b267760e01b8152600481018d9052602401610627565b836001600160a01b031663254bd6838e600185600081518110610dcd57610dcd611d68565b602002602001015160000151610de39190611adf565b6040516001600160e01b031960e085901b16815263ffffffff929092166004830152602482015260016044820152606401600060405180830381865afa158015610e31573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052610e599190810190611bb7565b9150610e66565b50610e6c565b50610d0f565b80600081518110610e7f57610e7f611d68565b6020026020010151600001519850610eb281600081518110610ea357610ea3611d68565b60200260200101516060015190565b9750610ee281600081518110610eca57610eca611d68565b6020026020010151604001516001600160401b031690565b965060008a118015610f05575042610f038b6001600160401b038a16611b44565b105b15610f475788610f1e6001600160401b03891642611adf565b604051631fc476cf60e21b815260048101929092526024820152604481018b9052606401610627565b604051632ee2a87f60e21b8152600481018a90526001600160a01b0384169063bb8aa1fc90602401606060405180830381865afa158015610f8c573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610fb09190611b6e565b909150905080955050846001600160a01b0316638b85902b6040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015611013575060408051601f3d908101601f1916820190925261101091810190611af2565b60015b1561101b5795505b50505050945094509450945094565b600080600080600080886001600160a01b0316633c9f397c6040518163ffffffff1660e01b8152600401602060405180830381865afa158015611071573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906110959190611d7e565b90506110a389828a8a610c36565b939d929c50909a50985090965090945092505050565b6000806000806000886001600160a01b0316633c9f397c6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156110ff573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906111239190611d7e565b905061113189898989610a4c565b9297509095509350915063ffffffff8085169082161461117b576040516323fa115960e21b81526004810189905263ffffffff808316602483015285166044820152606401610627565b50945094509450949050565b6000816001600160a01b0316639b5f694a6040518163ffffffff1660e01b8152600401602060405180830381865afa9250505080156111e3575060408051601f3d908101601f191682019092526111e0918101906119bf565b60015b61120057604051638b4df23f60e01b815260040160405180910390fd5b6001600160a01b03811661122757604051638b4df23f60e01b815260040160405180910390fd5b92915050565b919050565b6000816001600160a01b031663f2b4e6176040518163ffffffff1660e01b8152600401602060405180830381865afa92505050801561128e575060408051601f3d908101601f1916820190925261128b918101906119bf565b60015b6112ab57604051635a23942360e11b815260040160405180910390fd5b6001600160a01b03811661122757604051635a23942360e11b815260040160405180910390fd5b60006001826001600160a01b031663200d2ed26040518163ffffffff1660e01b8152600401602060405180830381865afa158015611314573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906113389190611d9b565b6002811115611349576113496118cd565b148061122757506112278261163b565b6000806000905060006001856001600160a01b0316634d1975b46040518163ffffffff1660e01b8152600401602060405180830381865afa1580156113a2573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906113c69190611af2565b6113d09190611adf565b90505b80821161163357604051632ee2a87f60e21b8152600481018390526000906001600160a01b0387169063bb8aa1fc90602401606060405180830381865afa158015611422573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906114469190611b6e565b50604051632ee2a87f60e21b815260048101859052909250600091506001600160a01b0388169063bb8aa1fc90602401606060405180830381865afa158015611493573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906114b79190611b6e565b50915050856114cc836001600160401b031690565b6001600160401b031611156114f1576114e6600185611adf565b945050505050611227565b60006001600160401b0383811690831611156115665761151d6001600160401b03848116908416611dbc565b6001600160401b03166115308686611adf565b6115436001600160401b0386168a611adf565b61154d9190611b0b565b6115579190611b22565b6115619086611b44565b611568565b845b9050838111156115755750825b604051632ee2a87f60e21b8152600481018290526000906001600160a01b038a169063bb8aa1fc90602401606060405180830381865afa1580156115bd573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906115e19190611b6e565b5091505060006115f7826001600160401b031690565b905088816001600160401b03161161161b57611614836001611b44565b9650611629565b611626600184611adf565b95505b50505050506113d3565b949350505050565b60006002826001600160a01b031663200d2ed26040518163ffffffff1660e01b8152600401602060405180830381865afa15801561167d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906116a19190611d9b565b60028111156116b2576116b26118cd565b036116bf57506000919050565b6001826001600160a01b0316638980e0cc6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156116ff573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906117239190611af2565b111561173157506001919050565b6040516331bc0c2360e21b8152600060048201819052906001600160a01b0384169063c6f0308c9060240160e060405180830381865afa158015611779573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061179d9190611ddb565b505050505091505060006001600160a01b0316816001600160a01b0316146117c85750600192915050565b50600092915050565b6001600160a01b03811681146117e657600080fd5b50565b600080600080608085870312156117ff57600080fd5b843561180a816117d1565b966020860135965060408601359560600135945092505050565b606081016112278284805182526001600160801b0360208201511660208301526001600160801b0360408201511660408301525050565b60008060006060848603121561187057600080fd5b833561187b816117d1565b95602085013595506040909401359392505050565b828152608081016103956020830184805182526001600160801b0360208201511660208301526001600160801b0360408201511660408301525050565b634e487b7160e01b600052602160045260246000fd5b6002811061190157634e487b7160e01b600052602160045260246000fd5b9052565b60006080820190506119188284516118e3565b60208301516020830152604083015160408301526060830151606083015292915050565b60006020828403121561194e57600080fd5b8135610395816117d1565b6020810161122782846118e3565b63ffffffff811681146117e657600080fd5b6000806000806080858703121561198f57600080fd5b843561199a816117d1565b935060208501356119aa81611967565b93969395505050506040820135916060013590565b6000602082840312156119d157600080fd5b8151610395816117d1565b634e487b7160e01b600052604160045260246000fd5b60405160a081016001600160401b0381118282101715611a1457611a146119dc565b60405290565b604051601f8201601f191681016001600160401b0381118282101715611a4257611a426119dc565b604052919050565b6001600160801b03811681146117e657600080fd5b60006060828403128015611a7257600080fd5b50604051606081016001600160401b0381118282101715611a9557611a956119dc565b604052825181526020830151611aaa81611a4a565b60208201526040830151611abd81611a4a565b60408201529392505050565b634e487b7160e01b600052601160045260246000fd5b8181038181111561122757611227611ac9565b600060208284031215611b0457600080fd5b5051919050565b808202811582820484141761122757611227611ac9565b600082611b3f57634e487b7160e01b600052601260045260246000fd5b500490565b8082018082111561122757611227611ac9565b80516001600160401b038116811461122d57600080fd5b600080600060608486031215611b8357600080fd5b8351611b8e81611967565b9250611b9c60208501611b57565b91506040840151611bac816117d1565b809150509250925092565b600060208284031215611bc957600080fd5b81516001600160401b03811115611bdf57600080fd5b8201601f81018413611bf057600080fd5b80516001600160401b03811115611c0957611c096119dc565b8060051b611c1960208201611a1a565b91825260208184018101929081019087841115611c3557600080fd5b6020850192505b83831015611d5d5782516001600160401b03811115611c5a57600080fd5b850160a0818a03601f19011215611c7057600080fd5b611c786119f2565b6020828101518252604083015190820152611c9560608301611b57565b60408201526080820151606082015260a08201516001600160401b03811115611cbd57600080fd5b60208184010192505089601f830112611cd557600080fd5b81516001600160401b03811115611cee57611cee6119dc565b611d01601f8201601f1916602001611a1a565b8181528b6020838601011115611d1657600080fd5b60005b82811015611d3557602081860181015183830182015201611d19565b5060006020838301015280608084015250508084525050602082019150602083019250611c3c565b979650505050505050565b634e487b7160e01b600052603260045260246000fd5b600060208284031215611d9057600080fd5b815161039581611967565b600060208284031215611dad57600080fd5b81516003811061039557600080fd5b6001600160401b03828116828216039081111561122757611227611ac9565b600080600080600080600060e0888a031215611df657600080fd5b8751611e0181611967565b6020890151909750611e12816117d1565b6040890151909650611e23816117d1565b6060890151909550611e3481611a4a565b608089015160a08a01519195509350611e4c81611a4a565b60c0890151909250611e5d81611a4a565b809150509295989194975092955056fea264697066735822122013c9ca5c68c37024a9b4368e048a2c1ff607f615fdb170ac9d3267f512232e3664736f6c634300081a0033
```

## Testing gateway

```
TARGET_ADDRESS=$TEST_L1_ADDRESS PROVIDER_URL=$L1_PROVIDER_URL npx hardhat run ../l1-verifier/scripts/remote.ts --network sepolia
```